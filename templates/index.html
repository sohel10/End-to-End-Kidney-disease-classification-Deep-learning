<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>cnncls</title>

    <link rel="stylesheet" 
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
          crossorigin="anonymous">

    <style>
        body { background-color: #eff2f9; }
        .iupload h3 { color: #1b2d6b; font-size: 30px; font-weight: 700; }

        .img-part { height:300px; width:300px; margin:0 auto; }
        .image-part { height:300px; width:300px; border:1px solid #1b2d6b; }

        .image-part img { position:absolute; height:300px; width:300px; display:none; padding:5px; }
        .image-part #video { display:block; height:300px; width:300px; padding:5px; }

        .res-part { border:1px solid #dedede; height:310px; width:100%; padding:5px; overflow:auto; }
        .res-part2 { border:1px solid #dedede; height:310px; width:100%; padding:5px; }

        #send { cursor:pointer; }

        #loading {
            position: fixed; left:0; top:0; width:100%; height:100%;
            z-index:9999999; background:rgba(255,255,255,0.7); display:none;
        }
        .loader {
            border:8px solid #f3f3f3; border-top:8px solid #363e75;
            border-radius:50%; width:60px; height:60px;
            position:absolute; top:50%; left:50%;
            margin-left:-30px; margin-top:-30px;
            animation:spin 2s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    </style>
</head>

<body>
<div class="main container">
    <section class="iupload">
        <h3 class="text-center py-4">Object Classification</h3>
        <div class="row">

            <!-- IMAGE PREVIEW -->
            <div class="img-part col-md-6">
                <div class="image-part">
                    <video autoplay id="video"></video>
                    <img src="" id="photo">
                    <canvas style="display:none;" id="canvas"></canvas>
                </div>

                <div class="btn-part">
                    <form>
                        <div class="input-group mt-3 row">
                            <button type="button" class="btn btn-primary col-md-5 ml-3 mr-4" id="uload">Upload</button>
                            <button id="send" type="button" class="btn btn-success col-md-5">Predict</button>
                        </div>

                        <!-- FIXED URL -->
                        <input type="hidden" id="url" value="/predict"/>

                        <input name="upload" type="file" id="fileinput" style="position:absolute; top:-500px;">
                    </form>
                </div>
            </div>

            <!-- OUTPUT DISPLAY -->
            <div class="col-md-6">
                <h5 class="mb-2 text-center">Prediction Results</h5>
                <div class="row">
                    <div class="res-part2 col-md-5"></div>
                    <div class="res-part col-md-5"><div class="jsonRes"></div></div>
                </div>
            </div>

        </div>
    </section>
</div>

<div id="loading"><div class="loader"></div></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script>
var base_data = "";

// SEND REQUEST TO FLASK
function sendRequest(base64Data){
    if (!base64Data) return;

    $("#loading").show();
    var url = $("#url").val();

    $.ajax({
        url: url,
        type: "POST",
        async: true,
        crossDomain: true,
        headers: { "Content-Type": "application/json" },
        data: JSON.stringify({ image: base64Data }),

        success: function(res){
            $(".res-part").html("");
            $(".res-part2").html("");

            // ðŸ”¥ FIX â€” ONLY USE res[0]
            $(".res-part").html("<pre>" + JSON.stringify(res[0], null, 2) + "</pre>");

            $("#loading").hide();
        }
    });
}

$(document).ready(function(){

    // PREDICT BUTTON
    $('#send').click(function(){
        sendRequest(base_data);
    });

    // UPLOAD BUTTON
    $('#uload').click(function(){
        $('#fileinput').click();
    });

    // FILE INPUT â†’ BASE64
    $("#fileinput").change(function(){
        if (this.files && this.files[0]){
            var reader = new FileReader();

            reader.onload = function(e){
                var url = e.target.result;
                var img = new Image();

                img.onload = function(){
                    var canvas = document.createElement("canvas");
                    var ctx = canvas.getContext("2d");

                    canvas.height = this.height;
                    canvas.width = this.width;
                    ctx.drawImage(this, 0, 0);

                    base_data = canvas.toDataURL("image/jpeg", 1.0)
                                   .replace(/^data:image.+;base64,/, "");

                    $('#photo').attr('src', url).show();
                    $('#video').hide();
                };

                img.src = url;
            };

            reader.readAsDataURL(this.files[0]);
        }
    });
});
</script>

</body>
</html>
